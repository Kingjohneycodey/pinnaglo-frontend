<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./admin.css">
    <link rel="stylesheet" href="paymentProof.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>ElonTradesFx/Admin</title>
</head>
<body>

  <!-- SIDEBAR CONTAINER -->
  <div class="sidebar-container" id="sidebar-container">
    <div class="sidebar-wrapper">
        <div class="logo-container">
            <h2>ElonTradesFx</h2>
        </div>
        <div class="sidebar-list-item-container">
            <ul class="sidebar-list-items">
                <a class="sidebar-list-item" href="./admin.html">
                    <li>Users</li>
                </a>
                <a class="sidebar-list-item" href="./paymentProof.html">
                    <li>Payment Proofs</li>
                </a>
                <a class="sidebar-list-item" href="./withdrawalAdmin.html">
                    <li>Withdrawals</li>
                </a>
                <a class="sidebar-list-item" href="./withdrawalFee.html">
                    <li>Withdrawal Fees</li>
                </a>
            </ul>
        </div>
    </div>
</div>

    <!-- MAIN BODY CONTAINER -->
    <section class="main-body-container" id="main-container">
        <div class="main-header">
            <div class="main-header-wrapper">
                <div class="navbar-logo-icon">
                    <i class="fa-solid fa-bars main-header-icon" id="menubar"></i>
                </div>
                <div class="log-out-icon-container main-header-icon">
                    <i class="fa-solid fa-power-off"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <!-- MAIN SECTION BODY -->
        <div class="main-section-body-container">
            <div class="main-section-body-container1" id="user-table-container">
                <h3>You have <span id="number-of-users">0</span> Users</h3>
                <div class="users-list-container">
                    <table class="table">
                                <tr class="table-head">
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>phoneNumber</th>
                                    <th>Date Joined </th>
                                </tr>
                                <!-- <hr> -->
                                <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- USER ACTIVITIES SECTION -->
            <div class="user-activities-container" id="user-activity-container">
                <h3><span id="username"></span>'s Payment Proofs</h3>
                <div class="paymentProof-container" id='paymentProof'>
                    <!-- <div class="paymentProof-image-container">
                        <img src='https://firebasestorage.googleapis.com/v0/b/williams-39101.appspot.com/o/paymentProof%2FhLmNjDZRSSXv0m35S2HtCBwd3t92%2F1679490653269?alt=media&token=908ed39d-c5e0-4acd-81ef-db5ad0b8066b'/>
                    </div> -->
                </div>

                <!-- Plans Users -->

                <!-- <div class="plan-table">
                    <div class="h3">Packages Joined</div>
                    <div class="user-plan-table">
                        <table class="table">
                            <tr class="table-head">
                                <th>Amount</th>
                                <th>Package</th>
                                <th>Date</th>
                            </tr>
                            <tbody id="pln-table-body"></tbody>
                        </table>
                    </div>
                </div> -->
            </div>

        </div>

    </section>

</body>

<!-- Firebase -->
<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, set, ref as dataRef, update, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getStorage, getDownloadURL, uploadBytes, ref as storeRef, listAll, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDzhzn6ZskehWvHr-SpjHW60e1nCb3LSKw",
        authDomain: "elontradesfx.firebaseapp.com",
        projectId: "elontradesfx",
        storageBucket: "elontradesfx.appspot.com",
        messagingSenderId: "51146864031",
        appId: "1:51146864031:web:470b6f36a5c1e6bf34b9aa"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app)
    const auth = getAuth()
    const storage = getStorage(app);
    // const StorageRef =
    let Data = []
    let userId

             // Check authentication state
  onAuthStateChanged(auth, (user) => {
    if (!user ) {
      // User is not signed in, redirect to the login page
      window.location.href = "./Login Page/login.html";
    } else {
    // console.log('admin logged in')
      const userRef = ref(database, `users/${userId}`);
    //   console.log(user)
      get(userRef)
        .then((snapshot) => {
          const userData = snapshot.val();
          if (userData.role !== 'admin' ) {
              // User does not have access to this page, redirect to the error page
              window.location.href = "./Login Page/login.html";
            }
        })
        .catch((error) => {
            // console.log("Error checking user data:", error);
        });
    }
});

    var userTable = document.getElementById('users-table-body')
    var numberOfUsers = document.getElementById('number-of-users')
    var deposite = document.getElementById('deposite-table-body')
    var userName = document.getElementById('username')
    var Plan = document.getElementById('pln-table-body')
    var userTableContainer = document.getElementById('user-table-container')
    var userActivityContainer = document.getElementById('user-activity-container')
    var menubar = document.getElementById('menubar')
    var sidebar = document.getElementById('sidebar-container')
    var mainContainer = document.getElementById('main-container')
    var paymentProof = document.getElementById('paymentProof')
    let users = []

    const AddToUsersTable = ( username, email, phoneNumber, Date, userId ) => {

        var UserInfo = {
            username,
            email,
            phoneNumber,
            Date,
            userId
        }

        let trow = document.createElement('tr')
        let nameRow = document.createElement('td')
        let emailRow = document.createElement('td')
        let phoneNumberRow = document.createElement('td')
        let dateRow = document.createElement('td')

        nameRow.innerHTML = username
        emailRow.innerHTML = email
        phoneNumberRow.innerHTML = phoneNumber
        dateRow.innerHTML = Date

        trow.classList.add('table-data')
        trow.appendChild(nameRow)
        trow.appendChild(emailRow)
        trow.appendChild(phoneNumberRow)
        trow.appendChild(dateRow)
        userTable.appendChild(trow)
        
        trow.addEventListener('click',() => {
            // console.log(UserInfo.userId)
            userTableContainer.style.display='none'
            userActivityContainer.style.display='block'
            userName.innerHTML=UserInfo.username
        const AddToImageList = ( location, path ) => {
            console.log(location, path)
            const image = document.createElement('img')
            const div = document.createElement('div')

            const Path = path.replace(/\//g,"%2F");
            
            
            image.setAttribute('src',`https://firebasestorage.googleapis.com/v0/b/elontradesfx.appspot.com/o/${Path}?alt=media`)
            div.classList.add('paymentProof-image-container')
            div.appendChild(image)

            paymentProof.appendChild(div)
        }

        const getImagesOnce = (list) => {
        list.forEach(image => {
            AddToImageList(image.bucket, image.path)
        })
   }

        listAll(storeRef(storage, `paymentProof/${userId}`)).then( async(res) => {
            let list = []
            const imageUrls = await res.items.forEach((item) => 
                // 'https://firebasestorage.googleapis.com/v0/b/'+item._location.bucket+ item._location.path
                list.push(item._location)
                // console.log(item._location.bucket, item._location.path)
            );
            getImagesOnce(list)
            // Promise.all(imageUrls).then((Urls) => {
            //     console.log(Urls);
            // });
            console.log(res)
        }).catch((error) => {
            console.log(error)
        })

        })
    }

    const getDataOnce = (users) => {
        users.forEach(user => {
            AddToUsersTable(user.username, user.email, user.phoneNumber, user.date, user.userId)
            // User.push(user)
        })
   }

   menubar.addEventListener('click', () => {
        console.log('you clicked me')
        sidebar.classList.toggle('active')
    })
    sidebar.addEventListener('click', () => {
        console.log('you clicked me')
        sidebar.classList.remove('active')
    })
    // mainContainer.addEventListener('click', () => {
    //     sidebar.classList.remove('active')
    // })


    setTimeout(() => {
    //    console.log(database)
       onValue(dataRef(database, `users/`), (snapshot) => {
           const data = snapshot.val();
        snapshot.forEach(childSnapshot => {
            users.push(childSnapshot.val())
        })
        
        getDataOnce(users)
        console.log(users)
        numberOfUsers.innerHTML=users.length
       })
    }, 3000)

</script>

</html>